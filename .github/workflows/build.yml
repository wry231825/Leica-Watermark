name: Build Native Android
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Auto-Generate Android Project Structure
        run: |
          # ========================================================
          # 终极骗术：先给它一个空的 settings.gradle 文件。
          # 这样它既不会报错说“这不是项目”，也不会因为读取插件而崩溃！
          # ========================================================
          echo "" > settings.gradle
          gradle wrapper --gradle-version 8.4
          
          # 引擎准备好了！现在开始生成真正的项目结构和配置文件
          mkdir -p app/src/main/java/com/app/leica
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/font
          
          cat << 'EOF' > build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { 
                  classpath "com.android.tools.build:gradle:8.2.0"
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.20" 
              }
          }
          EOF
          
          # 覆盖刚才那个骗它用的空 settings.gradle
          cat << 'EOF' > settings.gradle
          rootProject.name = "LeicaMaker"
          include ':app'
          EOF
          
          cat << 'EOF' > app/build.gradle
          plugins { id 'com.android.application'; id 'org.jetbrains.kotlin.android' }
          android {
              namespace 'com.app.leica'
              compileSdk 34
              defaultConfig { applicationId "com.app.leica"; minSdk 24; targetSdk 34; versionCode 1; versionName "1.0" }
              buildFeatures { compose true }
              composeOptions { kotlinCompilerExtensionVersion '1.5.4' }
          }
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.lifecycle:lifecycle-runtime-ktx:2.6.2'
              implementation 'androidx.activity:activity-compose:1.8.1'
              implementation platform('androidx.compose:compose-bom:2023.10.01')
              implementation 'androidx.compose.ui:ui'
              implementation 'androidx.compose.material3:material3'
              implementation 'io.coil-kt:coil-compose:2.5.0'
              implementation 'androidx.exifinterface:exifinterface:1.3.7'
          }
          EOF
          
          cat << 'EOF' > app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application android:allowBackup="true" android:label="Leica Maker" android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # 移动素材文件
          mv MainActivity.kt app/src/main/java/com/app/leica/MainActivity.kt
          mv logo.png app/src/main/res/drawable/logo.png
          mv font.ttf app/src/main/res/font/font.ttf

      - name: Build APK with Gradle
        run: |
          # 此时 ./gradlew 已经是刚刚用空文件骗出来的纯正 8.4 版本了！
          ./gradlew assembleDebug --no-daemon

      - name: Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: LeicaMaker-App
          path: app/build/outputs/apk/debug/app-debug.apk
          compression-level: 0
